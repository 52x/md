title: XSS 和 CSRF 攻击研究
date: 2017-4-7
tags: [JavaScript,Web安全]
---
# Web安全
在前端开发领域，理解 Web 安全也是很重要的基本需求，因为确保 Web 站点或 Web 应用安全十分重要，这个需要服务器端和前端人员协同合作，才能避免用户隐私信息被泄露和黑客攻击。
下面就了解一下主要的两种攻击方式：

## XSS
XSS（Cross-site scripting 跨站脚本）是一种网站应用程序的安全漏洞攻击，是代码注入的一种。它允许恶意用户将代码注入到网页上，其他用户在观看网页时就会受到影响。这类攻击通常包含了HTML以及用户端脚本语言。
XSS攻击通常指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java，VBScript，ActiveX，Flash或者甚至是普通的HTML。攻击成功后，攻击者可能得到更高的权限（如执行一些操作）、私密网页内容、会话和cookie等各种内容。

### 攻击场景：
攻击者使被攻击者在浏览器中执行脚本后，如果需要收集来自被攻击者的数据（如cookie或其他敏感信息），可以自行架设一个网站，让被攻击者通过JavaScript等方式把收集好的数据作为参数提交，随后以数据库等形式记录在攻击者自己的服务器上。

### 攻击手段：
1. 盗用cookie，获取敏感信息。
2. 利用植入Flash，通过crossdomain权限设置进一步获取更高权限；或者利用Java等得到类似的操作。
3. 利用iframe、frame、XMLHttpRequest或上述Flash等方式，以（被攻击）用户的身份执行一些管理动作，或执行一些一般的如发微博、加好友、发私信等操作。
4. 利用可被攻击的域受到其他域信任的特点，以受信任来源的身份请求一些平时不允许的操作，如进行不当的投票活动。
5. 在访问量极大的一些页面上的XSS可以攻击一些小型网站，实现DDoS攻击的效果。

### 防御手段：
#### 网站用户防御方法
1. 包括Internet Explorer、Firefox在内的大多数浏览器皆有关闭JavaScript的选项，但关闭功能并非是最好的方法，因为许多网站都需要使用JavaScript语言才能正常运作。

#### 网站开发者防御手段
1. 过滤特殊字符。避免XSS的方法之一主要是将用户所提供的内容进行过滤。
2. 使用HTTP头指定类型。可以使用HTTP头指定内容的类型，使得输出的内容避免被作为HTML解析。

### 后注：
我们知道 AJAX 技术所使用的 XMLHttpRequest 对象都被浏览器做了限制，只能访问当前域名下的 URL，所谓不能“跨域”问题。这种做法的初衷也是防范 XSS，但不是总有用，因为用 iframe 也一样可以达到相同的目的。还能用 iframe 发起 POST 请求。
当然，现在一些浏览器能够很智能地分析出部分 XSS 并予以拦截，例如新版的 Firefox、Chrome 都能这么做。但拦截不总是能成功。从原则上讲，我们也不应该把事关安全性的责任推脱给浏览器，所以防止 XSS 的根本之道还是过滤用户输入。用户输入总是不可信任的，这点对于 Web 开发者应该是常识。

如果我们不需要用户输入 HTML 而只想让他们输入纯文本，那么把所有用户输入进行 HTML 转义输出是个不错的做法。
如果一些场合我们要允许用户输入 HTML，又要过滤其中的脚本。简单的方法就是白名单重新整理。用户输入的 HTML 可能拥有很复杂的结构，但我们并不将这些数据直接存入数据库，而是使用 HTML 解析库遍历节点，获取其中数据。然后根据用户原有的标签属性，重新构建 HTML 元素树。构建的过程中，所有的标签、属性都只从白名单中拿取。


## CSRF
CSRF（Cross-site request forgery 跨站请求伪造），是一种挟制用户在当前已登录的Web应用程序上执行非本意的操作的攻击方法。跟跨网站脚本（XSS）相比，XSS 利用的是用户对指定网站的信任，CSRF 利用的是网站对用户网页浏览器的信任。它与XSS非常不同，并且攻击方式几乎相左。往往不大流行（因此对其进行防范的资源也相当稀少）和难以防范，所以被认为比XSS更具危险性。

### 攻击场景：
攻击者通过一些技术手段欺骗用户的浏览器去访问一个自己曾经认证过的网站并执行一些操作（如发邮件，发消息，甚至财产操作如转账和购买商品）。由于浏览器曾经认证过，所以被访问的网站会认为是真正的用户操作而去执行。这利用了web中用户身份验证的一个漏洞：简单的身份验证只能保证请求发自某个用户的浏览器，却不能保证请求本身是用户自愿发出的。

### 攻击手段：
1. 以用户名义发送邮件和发消息
2. 盗取用户的账号
3. 使用用户帐号来购买商品、虚拟货币转账

### 防御手段：
#### 网站用户防御方法
1. 不要轻易打开第三方连接。（如果邮件内部有第三方连接你打开的时候都会有相应的提示信息，谨慎操作）
2. 尽量不要使用网站的"自动登陆”。如果你是一打开浏览器就访问"攻击网站”，在它发送连接请求的时候就会触发自动登录的功能，从而盗取你的身份

#### 网站开发者防御手段
1. 使用Post请求（这种方式治标不治本，但可以提高攻击门槛）。对于修改和创建资源的API应该只接受 POST 请求，而 GET 请求应该只浏览而不改变服务器端资源。这样攻击者已经不可能通过发布链接来伪造请求了，但他们仍可以发布表单，或者在其他站点上使用我们肉眼不可见的表单，在后台用 js 操作，伪造请求。
2. 检查Referer字段。HTTP头中有一个Referer字段，这个字段用以标明请求来源于哪个地址。在处理敏感数据请求时，通常来说，Referer字段应和请求的地址位于同一域名下。
3. 验证码。验证码可以很好的解决上述问题,但是如果任何一个操作都加入验证码的话会导致用户体验下降，只能在用户操作重要数据的时候（尤其涉及到金额）。
4. 表单提供随机数。首先服务器端要以某种策略生成随机字符串，作为令牌（token），保存在 Session 里。然后在发出请求的页面，把该令牌以隐藏域一类的形式，与其他信息一并发出。在接收请求的页面，把接收到的信息中的令牌与 Session 中的令牌比较，只有一致的时候才处理请求，否则返回 HTTP 403 拒绝请求或者要求用户重新登录验证身份。因为理论上攻击者不能获得第三方的 Cookie，所以表单中的数据也就构造失败了。使用这个方法时注意：不能全局使用一个 Session Key。因为其理论上是可破解的，破解方式是解析来源页面的文本，获取令牌内容。如果全局使用一个 Session Key，那么危险系数会上升。原则上来说，每个页面的请求令牌都应该放在独立的 Session Key 中。我们在设计服务器端的时候，可以稍加封装，编写一个令牌工具包，将页面的标识作为 Session 中保存令牌的键。
